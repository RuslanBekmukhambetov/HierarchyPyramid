# Pyramid Hierarchy Importer

> Скрипт импорта иерархий из Excel в закрытую систему учёта электроэнергии **Пирамида 2.0**  
> Разработан в рамках производственной задачи на C# — с упором на читаемость, модульность и расширяемость

---

## Описание

**Pyramid Hierarchy Importer** — это скрипт на C#, который выполняет автоматический импорт **топологических** и **географических** иерархий объектов (ПС, ТП, улицы, дома и т.д.) из Excel-файла в систему учёта **Пирамида 2.0**.

Он обрабатывает данные построчно:
- Ищет прибор по серийному номеру;
- Извлекает технический и географический адрес;
- Построением вложенных иерархий занимается отдельный сервис;
- Результат и ошибки выводятся в Excel.

---

## Особенности среды исполнения

Данный проект не является самостоятельным приложением, а работает внутри среды **"Пирамида 2.0"**:

- использует внутренний API `ObjStudioClasses`;
- не поддерживает `async/await`;
- **невозможна загрузка из конфигурационных файлов**;
- **невозможно использовать unit-тесты или .csproj**;
- путь к Excel-файлу захардкожен (по условиям среды).

---

## Как работает скрипт

1. Загружается Excel-файл `C:\HierarchyImport.xlsx`;
2. Инициализируются зависимости (логгер, классификаторы, сервисы);
3. Для каждой строки:
   - извлекается серийный номер счётчика;
   - создаются DTO: технический и географический адрес;
   - строятся иерархии: сначала сеть, потом география;
   - ошибки логируются, результаты записываются в Excel.

> В случае ошибок парсинга или построения — строка пропускается, скрипт продолжает обработку остальных.

---

## Структура проекта

```
PyramidHierarchyImporter/
├── src/
│   ├── Interfaces/            # Интерфейсы для зависимостей
│   ├── Models/                # DTO и модели данных
│   ├── Services/              # Логика обработки, импорта, логгирования
│   ├── ColumnMap.cs           # Маппинг столбцов таблицы Excel
│   ├── Settings.cs            # Конфигурация параметров
│   ├── SettingsBuilder.cs     # Паттерн Builder для конфигурации
│   └── Script.cs              # Главный исполняемый скрипт
├── README.md
```

---

## Используемые технологии

| Компонент              | Назначение                            |
|------------------------|----------------------------------------|
| **C#**                 | Язык реализации                       |
| **GemBox.Spreadsheet** | Работа с Excel-файлом                 |
| **ObjStudioClasses**   | Внутренний API Пирамида 2.0           |

> `ObjStudioClasses` и другие внутренние классы (например, `ElectricityMeter`, `PowerLine`, `ClassifierItem`) являются частью проприетарной среды исполнения и **не публикуются** в репозитории.

---

## Почему нет unit-тестов?

Из-за ограничений среды `Пирамида 2.0`:
- невозможен запуск NUnit/xUnit/MSTest;
- невозможно замокать объекты API;
- невозможно использовать `.csproj` или конфиги.

Тем не менее, проект построен с использованием **интерфейсов** и **внедрения зависимостей** (`ILogger`, `IExcelService`, `IMeterService`), что позволяет адаптировать код для тестирования в другом окружении.

---

## Архитектурные решения

- Использование паттерна **Builder** для конфигурации скрипта;
- DTO-объекты с встроенной валидацией (`isValid`);
- Делегаты и словари для построения иерархий;
- Разделение логики по `Interfaces`, `Models`, `Services`;
- Логгирование ошибок и результатов с записью в Excel.

---

## Пример использования

> Псевдокод — выполнение начинается с `Script.Execute()`:

```csharp
public void Execute()
{
    var settings = new SettingsBuilder(logger)
        .SetWorkbookAndWorksheet(@"C:\HierarchyImport.xlsx")
        .SetMeters(ElectricityMeter.GetInstances())
        .SetClassifierNames("NetTopologicalClassifier", "GeographicalClassifier")
        .SetDirectoryOfCommonUserItems(DirectoryOfCommonUserItems.OnlyInstance)
        .SetColumnIndexes(0, 0, 22)
        .Build();

    foreach (var row in worksheet.Rows)
    {
        var meter = meterService.GetMeterPointBySerial(...);
        var dto = excelService.CreateTechnicalDto(row);
        technicalImporter.CreateOrGetTechnicalHierarchy(dto, meter, ...);
        ...
    }
}
```

---

## Лицензия

Этот проект распространяется под лицензией **MIT**.  
Использование в коммерческих продуктах или вне среды "Пирамида 2.0" **не допускается** без адаптации.

---

## Автор

> Разработчик: Ruslan Bekmukhambetov